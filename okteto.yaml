icon: https://raw.githubusercontent.com/okteto/icons/main/oktaco.png

build:
  menu:
    context: menu
  
  kitchen:
    context: kitchen

  kitchen-dev:
    context: kitchen
    target: dev

deploy:
  image: google/cloud-sdk:alpine
  commands:
  # only run this command if you are not Workload Identity
  - name: Create the GCP secret
    command: |
      echo ${GCP_SERVICE_KEY} | base64 -d > credentials.json
      kubectl create secret generic gcp-credentials --save-config --dry-run=client --from-file=credentials=credentials.json --from-literal=project=$GCP_PROJECT_ID -o yaml | kubectl apply -f -

  # only run this command if you are not Workload Identity
  - name: Configue GCP CLI
    command: |
      echo ${GCP_SERVICE_KEY} | base64 -d | gcloud auth activate-service-account --key-file=-
      gcloud --quiet config set project ${GCP_PROJECT_ID}

  - name: Create a GCP Pub/Sub resources
    command: |
      sh pubsub/deploy.sh

  - name: Deploy the Menu microservice
    command: |
      helm upgrade --install menu menu/chart --set image=$OKTETO_BUILD_MENU_IMAGE --set topic=$PUBSUB_TOPIC_NAME --set author="${OKTETO_NAMESPACE}-${OKTETO_USERNAME}"

  - name: Deploy the Kitchen microservice
    command: |
      helm upgrade --install kitchen kitchen/chart --set image=$OKTETO_BUILD_KITCHEN_IMAGE --set subscription=$PUBSUB_SUBSCRIPTION_NAME --set check=https://check-${OKTETO_NAMESPACE}.${OKTETO_DOMAIN}/checks

destroy:


external:
  readme:
    icon: okteto
    notes: README.md
    endpoints:
    - name: readme
      url: https://github.com/okteto/external-resources-gcp
  pubsub:
    icon: gcp
    notes: pubsub/notes.md
    endpoints:
    - name: topic
      url: https://example.com
  storage:
    icon: gcp
    notes: storage/notes.md
    endpoints:
    - name: bucket
      url: https://example.com
  api-docs:
    icon: dashboard
    notes: check/notes.md
    endpoints:
    - name: docs
      url: https://example.com

dev:
  menu:
    command: bash
    sync:
    - menu:/usr/src/app
    forward:
    - 9229:9229
  
  kitchen:
    image: ${OKTETO_BUILD_KITCHEN_DEV_IMAGE}
    command: bash
    sync:
    - kitchen:/usr/src/app
    environment:
     GIN_MODE: debug
  
  check:
    command: bash
    sync:
    - check:/usr/src/app
    environment:
     RELOAD: true

